//  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”   é¢„å¤‡çŸ¥è¯†   â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
//  åƒåœ¾å›æ”¶ ç« èŠ‚ä¸­çŸ¥é“ï¼ŒJavaScript å¼•æ“åœ¨å€¼â€œå¯è¾¾â€å’Œå¯èƒ½è¢«ä½¿ç”¨æ—¶ä¼šå°†å…¶ä¿æŒåœ¨å†…å­˜ä¸­ã€‚
let john = { name: "John" };

// è¯¥å¯¹è±¡èƒ½è¢«è®¿é—®ï¼Œjohn æ˜¯å®ƒçš„å¼•ç”¨
// è¦†ç›–å¼•ç”¨
john = null;
// è¯¥å¯¹è±¡å°†ä¼šè¢«ä»å†…å­˜ä¸­æ¸…é™¤

// ~ å¦‚æœæŠŠä¸€ä¸ªå¯¹è±¡æ”¾å…¥åˆ°æ•°ç»„ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªæ•°ç»„å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¹Ÿå°±å­˜åœ¨ï¼Œå³ä½¿æ²¡æœ‰å…¶ä»–å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚
let ann = { name: "Ann" };
let arr = [ann];
ann = null;

// å‰é¢ç”± ann æ‰€å¼•ç”¨çš„é‚£ä¸ªå¯¹è±¡è¢«å­˜å‚¨åœ¨äº† array ä¸­
// æ‰€ä»¥å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶
// æˆ‘ä»¬å¯ä»¥é€šè¿‡ array[0] è·å–åˆ°å®ƒ
console.log(arr[0]); // ? { name: 'Ann' }

// ! ç±»ä¼¼çš„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å¯¹è±¡ä½œä¸ºå¸¸è§„ Map çš„é”®ï¼Œé‚£ä¹ˆå½“ Map å­˜åœ¨æ—¶ï¼Œè¯¥å¯¹è±¡ä¹Ÿå°†å­˜åœ¨ã€‚å®ƒä¼šå ç”¨å†…å­˜ï¼Œå¹¶ä¸”ä¸ä¼šè¢«ï¼ˆåƒåœ¾å›æ”¶æœºåˆ¶ï¼‰å›æ”¶ã€‚
let szs = { name: "szs" };
let map = new Map();
map.set(szs, "27");
szs = null; // è¦†ç›–å¼•ç”¨
// szs è¢«å­˜å‚¨åœ¨äº† map ä¸­ï¼Œ
// æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ map.keys() æ¥è·å–å®ƒ
console.log(map.keys()); // ? [Map Iterator] { { name: 'szs' } }

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”   WeakMap  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ! WeakMap åœ¨è¿™æ–¹é¢æœ‰ç€æ ¹æœ¬ä¸Šçš„ä¸åŒã€‚å®ƒä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶æœºåˆ¶å¯¹ä½œä¸ºé”®çš„å¯¹è±¡ï¼ˆkey objectï¼‰çš„å›æ”¶ã€‚

// ! WeakMapï¼ˆé¿å…å†…å­˜æ³„éœ²ï¼‰ä¸ MapåŒºåˆ«

// ~ 1) WeakMap å’Œ Map çš„ç¬¬ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯ï¼ŒWeakMap çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œä¸èƒ½æ˜¯åŸå§‹å€¼ï¼š
let weakMap = new WeakMap();
let obj = {};
weakMap.set(obj, "ok");
// ä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºé”®
// weakMap.set("hh", "hehe"); // Errorï¼Œå› ä¸º "test" ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡

// ~ 2ï¼‰å¦‚æœæˆ‘ä»¬åœ¨ weakMap ä¸­ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”®ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–å¯¹è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ â€”â€” è¯¥å¯¹è±¡å°†ä¼šè¢«ä»å†…å­˜ï¼ˆå’Œmapï¼‰ä¸­è‡ªåŠ¨æ¸…é™¤ã€‚
let Nancy = { name: "Nancy" };
let wm = new WeakMap();
wm.set(Nancy, "person");
Nancy = null;
// ~ Nancy è¢«ä»å†…å­˜ä¸­åˆ é™¤äº†ï¼

/*
~ 3ï¼‰WeakMap ä¸æ”¯æŒè¿­ä»£ä»¥åŠ keys()ï¼Œvalues() å’Œ entries() æ–¹æ³•ã€‚æ‰€ä»¥æ²¡æœ‰åŠæ³•è·å– WeakMap çš„æ‰€æœ‰é”®æˆ–å€¼ã€‚

WeakMap åªæœ‰ä»¥ä¸‹çš„æ–¹æ³•ï¼š

    weakMap.get(key)
    weakMap.set(key, value)
    weakMap.delete(key)
    weakMap.has(key)


 * ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§é™åˆ¶å‘¢ï¼Ÿè¿™æ˜¯æŠ€æœ¯çš„åŸå› ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸¢å¤±äº†å…¶å®ƒæ‰€æœ‰å¼•ç”¨ï¼ˆå°±åƒä¸Šé¢ç¤ºä¾‹ä¸­çš„ Nancyï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶è‡ªåŠ¨å›æ”¶ã€‚ä½†æ˜¯åœ¨ä»æŠ€æœ¯çš„è§’åº¦å¹¶ä¸èƒ½å‡†ç¡®çŸ¥é“ ä½•æ—¶ä¼šè¢«å›æ”¶ã€‚

è¿™äº›éƒ½æ˜¯ç”± JavaScript å¼•æ“å†³å®šçš„ã€‚JavaScript å¼•æ“å¯èƒ½ä¼šé€‰æ‹©ç«‹å³æ‰§è¡Œå†…å­˜æ¸…ç†ï¼Œå¦‚æœç°åœ¨æ­£åœ¨å‘ç”Ÿå¾ˆå¤šåˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆ JavaScript å¼•æ“å¯èƒ½å°±ä¼šé€‰æ‹©ç­‰ä¸€ç­‰ï¼Œç¨åå†è¿›è¡Œå†…å­˜æ¸…ç†ã€‚
* å› æ­¤ï¼Œä»æŠ€æœ¯ä¸Šè®²ï¼ŒWeakMap çš„å½“å‰å…ƒç´ çš„æ•°é‡æ˜¯æœªçŸ¥çš„ã€‚JavaScript å¼•æ“å¯èƒ½æ¸…ç†äº†å…¶ä¸­çš„åƒåœ¾ï¼Œå¯èƒ½æ²¡æ¸…ç†ï¼Œä¹Ÿå¯èƒ½æ¸…ç†äº†ä¸€éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæš‚ä¸æ”¯æŒè®¿é—® WeakMap çš„æ‰€æœ‰é”®/å€¼çš„æ–¹æ³•ã€‚
*/

// ! ä½¿ç”¨åœºæ™¯1ï¼š WeakMap çš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯ é¢å¤–æ•°æ®çš„å­˜å‚¨ã€‚
// ~ å‡å¦‚æˆ‘ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ªâ€œå±äºâ€å¦ä¸€ä¸ªä»£ç çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œå¹¶æƒ³å­˜å‚¨ä¸€äº›ä¸ä¹‹ç›¸å…³çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å°±åº”è¯¥ä¸è¿™ä¸ªå¯¹è±¡å…±å­˜äº¡ â€”â€” è¿™æ—¶å€™ WeakMap æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„åˆ©å™¨ã€‚

// ~ æˆ‘ä»¬å°†è¿™äº›æ•°æ®æ”¾åˆ° WeakMap ä¸­ï¼Œå¹¶ä½¿ç”¨è¯¥å¯¹è±¡ä½œä¸ºè¿™äº›æ•°æ®çš„é”®ï¼Œé‚£ä¹ˆå½“è¯¥å¯¹è±¡è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶åï¼Œè¿™äº›æ•°æ®ä¹Ÿä¼šè¢«è‡ªåŠ¨æ¸…é™¤ã€‚
let someone = { name: "sth" };
weakMap.set(someone, "secret documents"); // å¦‚æœ someone æ¶ˆå¤±ï¼Œsecret documents å°†ä¼šè¢«è‡ªåŠ¨æ¸…é™¤

// ? â‘  ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ç”¨äºå¤„ç†ç”¨æˆ·è®¿é—®è®¡æ•°çš„ä»£ç ã€‚æ”¶é›†åˆ°çš„ä¿¡æ¯è¢«å­˜å‚¨åœ¨ map ä¸­ï¼šä¸€ä¸ªç”¨æˆ·å¯¹è±¡ä½œä¸ºé”®ï¼Œå…¶è®¿é—®æ¬¡æ•°ä¸ºå€¼ã€‚
// ? å½“ä¸€ä¸ªç”¨æˆ·ç¦»å¼€æ—¶ï¼ˆè¯¥ç”¨æˆ·å¯¹è±¡å°†è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ï¼‰ï¼Œè¿™æ—¶æˆ‘ä»¬å°±ä¸å†éœ€è¦ä»–çš„è®¿é—®æ¬¡æ•°äº†ã€‚

// 1) å‡å¦‚ä½¿ç”¨map
// ğŸ“ visitsCount.js
let visitsCountMap = new Map(); // map: user => visits count
// é€’å¢ç”¨æˆ·æ¥è®¿æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
// ä¸»ç¨‹åºä¸­
// ğŸ“ main.js
let Bob = { name: "Bob" };
countUser(Bob); // è®¡ç®—Bobçš„æ¥è®¿æ¬¡æ•°
// ~ ä¸ä¹…å Bobç¦»å¼€äº†
Bob = null;
// ~ ç°åœ¨ï¼Œjohn è¿™ä¸ªå¯¹è±¡åº”è¯¥è¢«åƒåœ¾å›æ”¶ï¼Œä½†å®ƒä»åœ¨å†…å­˜ä¸­ï¼Œå› ä¸ºå®ƒæ˜¯ visitsCountMap ä¸­çš„ä¸€ä¸ªé”®ã€‚
console.log(visitsCountMap.keys()); // [Map Iterator] { { name: 'Bob' } }
// * å½“æˆ‘ä»¬ç§»é™¤ç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç† visitsCountMapï¼Œå¦åˆ™å®ƒå°†åœ¨å†…å­˜ä¸­æ— é™å¢å¤§ã€‚åœ¨å¤æ‚çš„æ¶æ„ä¸­ï¼Œè¿™ç§æ¸…ç†ä¼šæˆä¸ºä¸€é¡¹ç¹é‡çš„ä»»åŠ¡ã€‚

// æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ WeakMap æ¥é¿å…è¿™æ ·çš„é—®é¢˜ï¼š
// ! 2) ä½¿ç”¨weakMap(æ­£ç¡®å§¿åŠ¿ï¼)
// ğŸ“ visitsCount.js
const visitsCountMap1 = new WeakMap(); // weakmap: user => visits count

// é€’å¢ç”¨æˆ·æ¥è®¿æ¬¡æ•°
function countUserWeakMap(user) {
  let count = visitsCountMap1.get(user) || 0;
  visitsCountMap1.set(user, count + 1);
}
// ! ç°åœ¨æˆ‘ä»¬ä¸éœ€è¦å»æ¸…ç† visitsCountMap äº†ã€‚å½“ user å¯¹è±¡å˜æˆä¸å¯è¾¾æ—¶ï¼Œå³ä¾¿å®ƒæ˜¯ WeakMap é‡Œçš„ä¸€ä¸ªé”®ï¼Œå®ƒä¹Ÿä¼šè¿åŒå®ƒä½œä¸º WeakMap é‡Œçš„é”®æ‰€å¯¹åº”çš„ä¿¡æ¯ä¸€åŒè¢«ä»å†…å­˜ä¸­åˆ é™¤ã€‚

// ! â‘¡ è¿˜æœ‰ç±»ä¼¼çš„ï¼š ç»™domå…ƒç´ æ·»åŠ æ•°æ®æˆ–è€…äº‹ä»¶ï¼ˆä¸DOMå…ƒç´ å…±ç”Ÿæ­»ï¼‰
// ä¾‹1 domå…ƒç´ è¢«æ¸…é™¤ å¯¹åº”çš„ä¿¡æ¯ä¹Ÿç›¸åº”åº”è¯¥è¢«åˆ é™¤
const weakm = new WeakMap();
const ele = document.getElementById("app");
weakm.set(ele, "some information");
weakm.get(ele);
// ä¾‹2 ç»‘å®šäº‹ä»¶
weakm.set(ele, { timeClicked: 0 });
// è®¡æ•° å¯¹eleèŠ‚ç‚¹çš„ç‚¹å‡»æ¬¡æ•°
// ä¸€æ—¦eleèŠ‚ç‚¹åˆ é™¤ï¼Œåˆ™timeClickedè¿™ä¸ªçŠ¶æ€å°±ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œä¸ä¼šå†…å­˜æ³„éœ²
ele.addEventListener("click", function () {
  let data = weakm.get(ele);
  data.timeClicked++;
});
// ? æ€»ç»“å°±æ˜¯weakMapå¾ˆé€‚åˆæ³¨å†Œç›‘å¬äº‹ä»¶
const listener = new WeakMap();
listener.set(ele, handler);
ele.addEventListener("click", listener.get(ele));
function handler() {
  console.log(111);
}
// ! ä½¿ç”¨åœºæ™¯2ï¼šç¼“å­˜
// æˆ‘ä»¬å¯ä»¥å­˜å‚¨ï¼ˆâ€œç¼“å­˜â€ï¼‰å‡½æ•°çš„ç»“æœï¼Œä»¥ä¾¿å°†æ¥å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„è°ƒç”¨å¯ä»¥é‡ç”¨è¿™ä¸ªç»“æœã€‚
// 1ï¼‰å‡å¦‚ä½¿ç”¨mapï¼ˆä¸æ˜¯æœ€ä½³æ–¹æ¡ˆï¼‰
// ğŸ“ cache.js
let cache = new Map();
// æŸä¸ªå¤æ‚è®¡ç®—
function sum(o) {
  return o.a + o.b;
}
// è®¡ç®—å¹¶ç¼“å­˜ç»“æœ
function process(obj) {
  if (!cache.has(obj)) {
    // åˆæ¬¡è°ƒç”¨è®¡ç®—ç»“æœ
    let result = sum(obj);
    cache.set(obj, result);
  }
  return cache.get(obj);
}

// ç°åœ¨åœ¨å…¶ä»–æ–‡ä»¶ä¸­å¤šæ¬¡éœ€è¦ä½¿ç”¨è¿™ä¸ªç»“æœ
// ğŸ“ main.js
let obj4 = { a: 2, b: 333 };
let result1 = process(obj4); // è®¡ç®—å®Œæˆ

// å…¶ä»–åœ°æ–¹åˆç”¨åˆ°äº†
let result2 = process(obj4); // å–è‡ªç¼“å­˜
console.log(result1 === result2, result1); // true
// ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡äº†
obj4 = null;
console.log(cache.size); // ? 1! ï¼ˆå•Šï¼è¯¥å¯¹è±¡ä¾ç„¶åœ¨ cache ä¸­ï¼Œå¹¶å æ®ç€å†…å­˜ï¼ï¼‰

// ~ å¯¹äºå¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåªéœ€åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è®¡ç®—å‡ºç»“æœï¼Œä¹‹åçš„è°ƒç”¨å¯ä»¥ç›´æ¥ä» cache ä¸­è·å–ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯ï¼Œå½“æˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™éœ€è¦æ¸…ç† cacheã€‚

// ! å¦‚æœæˆ‘ä»¬ç”¨ WeakMap æ›¿ä»£ Mapï¼Œä¾¿ä¸ä¼šå­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚å½“å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œå¯¹åº”ç¼“å­˜çš„ç»“æœä¹Ÿä¼šè¢«è‡ªåŠ¨ä»å†…å­˜ä¸­æ¸…é™¤ã€‚
// ğŸ“ cache.js
let weakCache = new WeakMap();

// ...
/*
  æ— æ³•è·å– cache.sizeï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª WeakMapï¼Œ
     è¦ä¹ˆæ˜¯ 0ï¼Œæˆ–å³å°†å˜ä¸º 0
     å½“ obj è¢«åƒåœ¾å›æ”¶ï¼Œç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤
 */

import{cwx as e,__global as t,loginCommon as n}from"../common";function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},o.apply(this,arguments)}var r,c=function(){var t={path:"NA",pageId:"NA"},n=e.getCurrentPage()||{};return n.route&&(t.path=n.route),n.pageId&&(t.pageId=n.pageId),t},s={groupPlatform:"ctrip_wechat",source:"sdk1.0",appId:t.appId},a=-1100,i=function(n,r){var a=r.code;"success"===n?a=0:void 0===r.code&&(a="");var i=o({},s,{scene:r.scene,stage:r.stage||"",code:""+a,result:n,path:c().path}),u=r.latency;Number.isNaN(u)&&(u=1),"fat"===t.env&&console.log("%c[cwx.user monitor]","color:#edf60b;",i),e.sendUbtByPage.ubtMetric({name:"bbz_accounts_login_statistics",tag:i,value:u})},u=function(e,t){void 0===t&&(t="");var n=0,o=e+"_total";return{start:function(){n=Date.now(),i("success",{scene:o,stage:t,code:0,latency:1})},success:function(){i("success",{scene:e,stage:t,latency:Date.now()-n,code:0})},fail:function(o){i("failed",{scene:e,stage:t,latency:Date.now()-n,code:o})}}},f=function(n){var o={scene:n,stage:"apiCall",path:c().path};"fat"===t.env&&console.log("%c[cwx.user apiCall]","color:#edf60b;",o),e.sendUbtByPage.ubtMetric({name:"wx_user_api_metric",tag:o,value:1})},d=function(n){"fat"===t.env&&console.log("%c[bbz accounts devTrace]","color: forestgreen;font-weight: bold",n),e.sendUbtByPage.ubtDevTrace("bbz_accounts_wx_flow",n||{})},l=function(t,n){e.sendUbtByPage.ubtTrace(t,n||{})},m=function(t,r){return new Promise(function(c,s){e.request(o({},n.getRequestObject("soa2/"+t,r||{},function(e){var t;200==(null==e?void 0:e.statusCode)?c(null!=(t=null==e?void 0:e.data)?t:{}):s(e)},s),{timeout:1e4}))})},g=null;function p(t){if(void 0===t&&(t=!0),t&&g&&"object"==typeof g&&Object.keys(g).length)return g;try{g=e.getSystemInfoSync()}catch(e){console.warn(e)}return g}p();var v,h,C=function(){var e=p();return e?e.platform:""},y="出错了，请再试一次",P=function(e){return null!=e},b=function(e,t){try{var n,o=function(){return d({type:"postH5Gateway",stage:"after",url:e,response:n,requestAt:r}),n},r=Date.now();d({type:"postH5Gateway",stage:"before",url:e,data:t,requestAt:r});var c=function(o,r){try{var c=Promise.resolve(m(e,t)).then(function(e){n=function(e){if(!P(e.ResponseStatus)||"Success"!==e.ResponseStatus.Ack)return{ok:!1,returnCode:-1105,message:y,data:e};var t=P(e.returnCode);return t&&0===e.returnCode?{ok:!0,returnCode:0,message:"success",data:e}:{ok:!1,returnCode:t?e.returnCode:-1105,message:e.message||y,data:e}}(e)})}catch(e){return r(e)}return c&&c.then?c.then(void 0,r):c}(0,function(e){n={ok:!1,returnCode:a,message:"网络错误，请稍后重试",data:e}});return Promise.resolve(c&&c.then?c.then(o):o())}catch(e){return Promise.reject(e)}},I=function(){var t,n=e.mkt.getUnion()||{},o=n.allianceid,s=void 0===o?"":o,a=n.sid,i=void 0===a?"":a,u={clientId:r||(r=e.getStorageSync("clientID")),deviceName:"",deviceType:(t=p(),t?t.model:""),osType:C(),pageId:c().pageId,allianceId:""+s,sid:""+i},f={};return Object.keys(u).forEach(function(e){f[e]=""+u[e]}),f},k=function(t){var n,o;e.user.auth=null!=(n=null==t?void 0:t.ticket)?n:"",e.user.duid=null!=(o=null==t?void 0:t.duid)?o:"",e.user.isNonUser="F"},w={fat:"https://accounts.fat1055.qa.nt.ctripcorp.com",uat:"https://accounts.uat.qa.nt.ctripcorp.com",prd:"https://accounts.ctrip.com"},T="/pages/myctrip/list/list?data="+JSON.stringify({id:"mobileSearch"}),N="wx0e6ed4f51db9d078",j=((v={})[N]={accessCode:"WEIXINAUTEHNTICATE"},v.wx5c0ef406698d0e86={accessCode:"CONTENTMINIAPPAUTHENTICATE"},v),A=j[N].accessCode;!function(e){e[e.authInvalid=90005]="authInvalid"}(h||(h={}));var S=function(){return(j[t.appId]||j[N]).accessCode},U=u("unionLogin"),O=function(e){f("unionLogin");var n=j[t.appId];if(n)return function(e,t){try{return U.start(),Promise.resolve(b("22160/unionLogin",{accessCode:e,token:t,clientInfo:I()})).then(function(e){return e.ok?(k(e.data),U.success()):U.fail(e.returnCode),e})}catch(e){return Promise.reject(e)}}(n.accessCode,e);throw console.warn("当前小程序不支持此API"),{ok:!1,returnCode:-1199,message:"当前小程序不支持此API"}},_=function(){f("clearAuth"),e.user.auth="",e.user.duid=""},x=u("logout"),L=function(n,o){f("logout"),x.start();var r={accessCode:S(),reason:"Userself",clientInfo:I()};b("24862/logout",r).then(function(r){r.ok?x.success():x.fail(r.returnCode),_(),null!=o&&o.syncH5&&function(n){var o=[["useminiProJump","T"]];null!=n&&n.from&&(o.push(["from",n.from]),o.push(["isTabBar",(null==n?void 0:n.isTabBar)||"F"]));var r=(w[t.env]||w.prd)+"/H5Login/logout?"+o.map(function(e){return e[0]+"="+e[1]}).join("&");e.component.cwebview({data:{url:encodeURIComponent(r),needLogin:!1}})}(o),"function"==typeof n&&n(!0)})},D=u("nonmemberLogin"),q=function(t,o){f("nonmemberLogin"),o&&o.retainLoginStatus&&!0===o.retainLoginStatus&&e.user.checkLoginStatusFromServer(function(e){!0===e&&t({returnCode:0,message:"非会员登录成功"})}),D.start();var r=c();e.request(n.getGatewayRequestObj("soa2/15431/NonMemberRegisterAndLoginWithoutRisk.json",{AccountHead:{Platform:"miniapp",Extension:{rmsToken:""}},Data:{accountHead:{sourceID:"55552689",locale:"zh_CN",group:"ctrip",platform:"miniapp"},extendedProperties:{clientID:e.clientID,Version:"1.0",Url:r.path,Platform:"miniapp",SourceID:"55552689",page_id:r.pageId,thirdConfigCode:"K7VI3185KWMRJOZ0KYA8QNIT"}}},function(n){try{var o=JSON.parse(n.data.Result);if(o&&o.ticket&&""!==o.ticket)e.user.auth=o.ticket,e.user.uid=o.uid,e.user.isNonUser="T",e.user.duid=o.extendedProperties.duid,D.success(),e.sendUbtByPage.ubtTrace("184606",{type:"nonmember"}),t({returnCode:0,message:"非会员登录成功"});else{var r="-1",c="非会员登录失败";o&&o.returnCode&&(r=o.returnCode),o&&o.message&&(c=o.message),D.fail(o&&o.returnCode?o.returnCode:"-2"),t({returnCode:r,message:c})}}catch(e){D.fail(-1199),t({returnCode:"-1",message:e.message})}},function(){D.fail(a),t({returnCode:-1,message:"非会员登录失败"})}))},R=function(t){f("isNonMember"),e.user&&e.user.isNonUser&&"T"===e.user.isNonUser?t&&t(!0):t&&t(!1)},B=function(t){f("mobileQueryOrder");var n,o=t||{};o.from||(o.from=T),n={param:o},e.getCurrentPage().navigateTo({url:"/pages/accounts/pages/searchorder/index",data:n.param})},E=u("writeCrossTicket"),H=function(e,t){try{f("writeCrossTicket"),E.start();var n=function(){if(e){var n={accessCode:A,token:e,clientInfo:I()};return Promise.resolve(b("22160/crossPlatformLogin",n)).then(function(e){e.ok?(k(e.data),E.success(),t(!0)):(E.fail(e.returnCode),t(!1))})}E.fail(-1005),t(!1)}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},M=u("exchangeAuthToken"),z=function(e){try{f("exchangeAuthToken"),M.start();var t={accessCode:S(),clientInfo:I()};return Promise.resolve(b("24863/exchangeAuthToken",t)).then(function(t){if(t.ok){var n=t.data.token;M.success(),e(n,!1)}else t.data.returnCode===h.authInvalid?(_(),M.success(),e("",!0)):(M.fail(t.returnCode),e("",!0))})}catch(e){return Promise.reject(e)}},J=u("precheckUserInfo"),F=function(){return new Promise(function(t,n){f("precheckUserInfo"),J.start(),e.login({success:function(e){try{var o=function(){if(e.code){var o={accessCode:S(),clientInfo:I(),code:e.code};return Promise.resolve(b("24863/quickLoginPreCheck",o)).then(function(e){e.ok?(J.success(),t(e.data)):(J.fail(e.returnCode),n({code:e.returnCode}))})}J.fail(-1010),n({code:-1010})}();return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},fail:function(){J.fail(-1011),n({code:-1011})}})})};function G(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var K=u("qconfigFc"),Q={CommonConfig:"15618/commonConfig.json"},W=function(e,t){try{return f("getQconf"),K.start(),Promise.resolve(G(function(){return Promise.resolve(m(e,t)).then(function(e){return K.success(),e})},function(e){return K.fail(a),Promise.reject(e)}))}catch(e){return Promise.reject(e)}},V=function(e,t){return Promise.resolve(G(function(){return Promise.resolve(W(e,{names:t})).then(function(e){var t,n,o;return JSON.parse(null!=(t=null==e||null==(n=e.data)||null==(o=n[0])?void 0:o.message)?t:"{}")})},function(){return{}}))},X=/*#__PURE__*/function(){function t(){this.config=void 0,this.config={}}var n=t.prototype;return n.refreshConfig=function(){try{return this.fetchCommonConfig(),Promise.resolve()}catch(e){return Promise.reject(e)}},n.fetchCommonConfig=function(){try{var t=this;return Promise.resolve(V(Q.CommonConfig,"fc")).then(function(n){return t.config.commonConfig=n,e.setStorageSync("bbz_accounts_common_config",n),n})}catch(e){return Promise.reject(e)}},n.getCommonConfigByName=function(e,t){var n;return"object"==typeof(null==(n=this.config)?void 0:n.commonConfig)&&Object.prototype.hasOwnProperty.call(this.config.commonConfig,e)?this.config.commonConfig[e]:t},t}(),Y=new X;export{Q as QConfigMap,X as Qconfig,z as exchangeAuthToken,W as getQconf,V as getQconfByName,R as isNonMember,f as logApiCall,d as logDevTrace,l as logTrace,L as logout,B as mobileQueryOrder,q as nonmemberLogin,F as precheckUserInfo,Y as qconfigSingleton,O as unionLogin,H as writeCrossTicket};

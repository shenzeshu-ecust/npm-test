"use strict";require("../../../../taroCommon"),(wx["tripTaroGlobal30"]=wx["tripTaroGlobal30"]||[]).push([[6174],{98038:function(e,t,n){var o=n(32180),r=n(45023),a=n(90134),i=n(298),u=(n(90201),n(72747)),c=n(91501),s=n(79301),d=n(95308),l=n(56034),p=n(90983),h=n(64571),f=n(61252),g=n(99739),v=n(10395),m=function(e,t){var n=(null===t||void 0===t?void 0:t.resourceList)||[],o=(0,g.ZP)()||{},r=(o.enviroment,o.cid);n.forEach((function(e){e.quantity=e.qty,delete e.qty}));var a=(0,v.Z)(e);return{useCouponParams:{clientEnv:{env:"prod",ctType:0,clientType:3},data:{source:"TICKET",miniType:"weapp",bookingInfo:{resourceList:n},allianceId:0,siteId:0,pageId:String((0,f.dD)()),locale:"zh-CN",currency:"CNY",clientId:r,saleChannel:23,extendInfoList:[{key:"needAutoReceive",value:"true"}]}},logs:a}},b={getFormatByModules:function(e,t,n){var o,r={request:e},a=(0,p.Z)(n);try{for(a.s();!(o=a.n()).done;){var u=o.value;switch(u){case"coupon-data":r.couponData=m(e,t);break;default:break}}}catch(e){a.e(e)}finally{a.f()}return r.request=(0,i.Z)((0,i.Z)({},e),{},{isShow:!0}),r},getRequestParams:function(){return(0,d.Z)((0,s.Z)().mark((function e(){var t,n,o,r,a,i,u,c,d,l;return(0,s.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if((0,f.Zz)({key:"menpiao_ticket_machine_metric",value:(new Date).getTime(),pos:"3"},"devtrace"),o=(0,h.FN)(),r=(null===o||void 0===o||null===(t=o.router)||void 0===t?void 0:t.params)||{},a=(null===o||void 0===o||null===(n=o.page)||void 0===n?void 0:n.$taroPath)||"",(0,f.Zz)({key:"menpiao_ticket_machine_metric",value:(new Date).getTime(),pos:"4"},"devtrace"),i=r.code,u=r.oid,c=r.sign,d="",!u){e.next=12;break}return d="".concat(null===o||void 0===o||null===(l=o.router)||void 0===l?void 0:l.path,"?code=").concat(i,"&oid=").concat(u,"&sign=").concat(c),e.abrupt("return",{orderid:u,ordersign:c,salecode:i,from:d,isShow:!1,isError:!1,url:a});case 12:return e.abrupt("return",{isShow:!1,url:a});case 13:case"end":return e.stop()}}),e)})))()}},x=n(57042),w=n(24460),k=n(12232),y=n(28570),Z=function(e,t){return{request:Object.assign({},t,e),actionUrl:"/restapi/soa2/15017/json/ticketMachineQueryTempOrderResource"}},C=function(){function e(t){var n=this;(0,x.Z)(this,e),(0,r.Z)(this,"target",void 0),this.target=t;var o=this.target.state.request;o.orderid?(0,k.Z)((function(e){"0"==(null===e||void 0===e?void 0:e.ReturnCode)?(t.toast.show("\u52a0\u8f7d\u4e2d..."),n.init(t)):(0,y.Sw)()}),!1,{checkLoginStatusFromServer:!0}):(t.afterFetch({request:(0,i.Z)((0,i.Z)({},o),{},{isShow:!0,isError:!0})}),t.confirm.show({title:"\u63d0\u793a",content:"\u7cfb\u7edf\u5f02\u5e38\uff0c\u8bf7\u91cd\u65b0\u63d0\u4ea4\u8ba2\u5355(10000)",btnOK:["\u786e\u5b9a"],btnCallBack:[function(){t.push("pages/home/homepage",!0)}]}))}return(0,w.Z)(e,[{key:"init",value:function(){var e=(0,d.Z)((0,s.Z)().mark((function e(t){var n,o,r,a,i,u,c,d;return(0,s.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=t.state.request,i=a.orderid,a.ordersign,a.salecode,a.from,u=[Z({orderId:i},t.header)],e.next=5,t.http({list:u});case 5:if(c=e.sent,t.toast.hide(),null===(n=c[0])||void 0===n||!n.ctripOrderId){e.next=11;break}return t.toast.show("\u8ba2\u5355\u5df2\u751f\u6210\uff0c\u5c06\u81ea\u52a8\u8df3\u8f6c\u81f3\u8ba2\u5355\u8be6\u60c5\u9875"),setTimeout((function(){t.push("/pages/ticket/order/detail?orderid=".concat(c[0].ctripOrderId),!0)}),1500),e.abrupt("return");case 11:if(null===(o=c[0])||void 0===o||!o.resourceList||c[0].resourceList.length){e.next=14;break}return t.confirm.show({title:"\u63d0\u793a",content:"\u8ba2\u5355\u5df2\u8fc7\u671f\uff0c\u8bf7\u5728\u673a\u5668\u4e0a\u91cd\u65b0\u63d0\u4ea4\u8ba2\u5355",btnOK:["\u786e\u5b9a"],btnCallBack:[function(){t.push("/pages/home/homepage","switchTab")}]}),e.abrupt("return");case 14:return null!==(r=c[0])&&void 0!==r&&r.resourceList||t.confirm.show({title:"\u63d0\u793a",content:"\u8ba2\u5355\u5df2\u8fc7\u671f\uff0c\u8bf7\u5728\u673a\u5668\u4e0a\u91cd\u65b0\u63d0\u4ea4\u8ba2\u5355",btnOK:["\u786e\u5b9a"],btnCallBack:[function(){t.push("/pages/home/homepage","switchTab")}]}),d=b.getFormatByModules(a,c[0],["coupon-data"]),t.afterFetch(d),e.abrupt("return");case 18:case"end":return e.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()}]),e}(),T=n(73627),_=n(52066),S=n(39140),I=function(e){var t=(0,l.eG)(e,O,"",D),n=t.target,o=t.state;return{state:o,target:n,toPay:P,onCouponSelect:N,onAutoClaim:B,onCouponError:q}},D=function(e){var t=e||{},n=t.couponData,o=t.startTime,r=n||{},a=r.logs,i=a||{},u=i.act_tvmcoupon_load_time;if(n&&o){var c=(new Date).getTime()-o,s=u({loadTime:c});(0,f.Zz)(s.params,s.type),e.startTime=0}},q=function(e,t){e.toast.show(null===t||void 0===t?void 0:t.message)},B=function(e,t){null!==t&&void 0!==t&&t.success?e.toast.show("\u5df2\u4e3a\u60a8\u81ea\u52a8\u9886\u53d6\u4f18\u60e0\u5238"):e.toast.show(t.message)},N=function(e,t){var n=t||{},o=n.state;if(!e.couponInfo)return o.couponSelectData=[];var r=(null===e||void 0===e?void 0:e.couponInfo)||{},a=r.couponCode,i=r.promotionId,u=r.deductionList,c=r.couponName,s=r.deductionAmount,d=null===u||void 0===u?void 0:u.find((function(e){return e.hit})),l=d.deductionStrategyId;o.couponDataNum={couponName:c,deductionAmount:s},o.couponSelectData=[{deductionStrategyId:l,couponCode:a,promotionId:i,discountAmount:String(s)}]},O=function(){var e=(0,d.Z)((0,s.Z)().mark((function e(t){return(0,s.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.afterFetch=function(e){var n=t.setState,o=(0,i.Z)({},e);n(o)},e.next=3,b.getRequestParams();case 3:return e.t0=e.sent,e.t1={},e.t2=(new Date).getTime(),t.state={request:e.t0,couponData:e.t1,startTime:e.t2},(0,f.Zz)({pageId:"10650080521",url:t.state.request.url,orderid:t.state.request.orderid},"pv"),(0,f.PX)({pageId:"10650080521"}),t.fetch=new C(t),e.abrupt("return",t.state);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),P=function(){var e=(0,d.Z)((0,s.Z)().mark((function e(t){var n,o,r,a,i,u,c,d,l,p,h,v,m,b,x,w,k,y,Z,C;return(0,s.Z)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.toast.show("\u6b63\u5728\u521b\u5efa\u8ba2\u5355...",1e3),e.next=3,_.Z.clear("ticketOrderData");case 3:return e.next=5,_.Z.clear("couponDataNum");case 5:if(i=t.state,u=i.request,c=i.couponSelectData,d=i.couponDataNum,l=u.orderid,p=u.ordersign,h=u.salecode,v=u.from,m=(0,g.ZP)(),b=m.taroEnv,x={orderid:l,ordersign:p,salecode:h,from:v,payVersion:"2.0",pageid:(0,f.dD)()||"10650000788",serverFrom:S.RN[b]},w="/pages/tnt/business/booking/o2obooking/booking/index?ishavecoupon=true",!c||!c.length){e.next=16;break}return x.prominput=c,w+="&isusecoupon=true",e.next=16,_.Z.set("couponDataNum",JSON.stringify(d));case 16:return k=[(0,T.Z)(x,t.header)],e.next=19,t.http({list:k});case 19:if(y=e.sent,t.toast.hide(),y[0].data&&1002!==(null===(n=y[0])||void 0===n||null===(n=n.head)||void 0===n?void 0:n.errmsg)){e.next=23;break}return e.abrupt("return",t.toast.show("\u7cfb\u7edf\u5f02\u5e38\uff0c\u8bf7\u91cd\u65b0\u63d0\u4ea4\u8ba2\u5355(10000-1)"));case 23:if(null===(o=y[0])||void 0===o||null===(o=o.head)||void 0===o||!o.errmsg){e.next=35;break}e.t0=null===(Z=y[0])||void 0===Z||null===(Z=Z.head)||void 0===Z?void 0:Z.errcode,e.next=1017===e.t0?27:30;break;case 27:return t.toast.show("\u8ba2\u5355\u5df2\u751f\u6210\uff0c\u5c06\u81ea\u52a8\u8df3\u8f6c\u81f3\u8ba2\u5355\u8be6\u60c5\u9875"),setTimeout((function(){t.push("/pages/ticket/order/detail?orderid=".concat(y[0].data.orderid),!0)}),1500),e.abrupt("break",33);case 30:return C={20101:"\u4f18\u60e0\u5238\u5df2\u88ab\u4f7f\u7528\uff0c\u672c\u5355\u65e0\u6cd5\u4f7f\u7528",20102:"\u8d85\u8fc7\u4e86\u4f7f\u7528\u9650\u5236",20103:"\u4f18\u60e0\u5238\u72b6\u6001\u65e0\u6548",20105:"\u8d26\u6237\u5f02\u5e38\uff0c\u4f18\u60e0\u5238\u4e0d\u53ef\u4f7f\u7528",20108:"\u4f18\u60e0\u5238\u5f02\u5e38,\u8bf7\u7a0d\u540e\u91cd\u8bd5",20112:"\u8be5\u4f18\u60e0\u5238\u5f53\u524d\u65f6\u95f4\u6bb5\u4e0d\u53ef\u4f7f\u7528",20126:"\u4f18\u60e0\u5238\u5f53\u524d\u65f6\u95f4\u6bb5\u4e0d\u53ef\u4f7f\u7528",20133:"\u4f18\u60e0\u5238\u5c1a\u672a\u751f\u6548"},t.confirm.show({content:C[null===(r=y[0])||void 0===r||null===(r=r.head)||void 0===r?void 0:r.errcode]||(null===(a=y[0])||void 0===a||null===(a=a.head)||void 0===a?void 0:a.errmsg)||"\u7cfb\u7edf\u5f02\u5e38\uff0c\u8bf7\u91cd\u65b0\u63d0\u4ea4\u8ba2\u5355(10000-1)",btnOK:["\u6211\u77e5\u9053\u4e86"],btnCallBack:[function(){t.push("/pages/home/homepage","switchTab")}]}),e.abrupt("break",33);case 33:e.next=38;break;case 35:return e.next=37,_.Z.set("ticketOrderData",JSON.stringify(y[0]));case 37:t.push(w,!0);case 38:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),V=I,j=n(59201),E=n(50738),F=n(9353),L=n(17366),A=n(56569),R=A.Db.get("window"),z=R.width,G=R.height,K={m_main:{height:"100%",display:"flex",flexDirection:"column",backgroundColor:"rgb(239,239,239)"},payBtn:{position:"fixed",bottom:0,width:z-(0,L.Vh)(32),backgroundColor:"#fff",paddingLeft:(0,L.Vh)(16),paddingRight:(0,L.Vh)(16),zIndex:10,height:(0,L.Vh)(60),display:"flex",alignItems:"center",boxShadow:"0px 6px 16px 2px rgba(0, 0, 0, 0.08)"},payBtn_block:{background:"linear-gradient(90deg, rgb(255, 177, 20) 0%, rgb(255, 119, 0) 100%)",paddingTop:(0,L.Vh)(12),paddingBottom:(0,L.Vh)(12),textAlign:"center",borderRadius:(0,L.Vh)(6),width:"100%"},payBtn_font:{color:"#fff",fontSize:(0,L.Vh)(17),fontWeight:"bold"},containerScroll:{height:G-(0,L.Vh)(60),backgroundColor:"#f4f4f4"},container:{height:G}},M=(0,F.Z)(K),J=n(2269);function X(e){var t=V(e),n=(t.state,t.target),o=t.toPay,r=t.onCouponSelect,a=t.onAutoClaim,s=t.onCouponError,d=n.state||{},l=d.couponData,p=(d.startTime,l||{}),h=p.useCouponParams,f=p.logs,g=f||{},v=g.act_tvmcoupon_pay_click,m=g.act_tvmcoupon_pay_expo;g.act_tvmcoupon_load_time;return l?(0,J.jsxs)(u.G7,{style:M.container,children:[(0,J.jsx)(u.pf,{scrollY:!0,style:M.containerScroll,enableFlex:!0,children:(0,J.jsx)(u.G7,{children:(0,J.jsx)(c.Z,(0,i.Z)((0,i.Z)({},h),{},{onSelect:function(e){return r(e,n)},needPopover:!1,visible:!0,needCodeInput:!1,onAutoClaim:function(e){return a(n,e)},onError:function(e){return s(n,e)}}))})}),(0,J.jsx)(j.Z,{onClick:function(){return o(n)},style:M.payBtn,log:v,testID:(0,E.kI)(m.key,m.params),children:(0,J.jsx)(u.G7,{style:M.payBtn_block,children:(0,J.jsx)(u.xv,{style:M.payBtn_font,children:"\u53bb\u652f\u4ed8"})})})]}):null}var Y=X,Q=(0,a.Z)(Y,(0,r.Z)({},S.NX.Mini,"ignore_page_pv"),"o2obooking"),U=Q,W=U,$={navigationBarTitleText:"\u4f18\u60e0\u5238",navigationBarTextStyle:"black"};Page((0,o.createPageConfig)(W,"pages/tnt/business/booking/o2obooking/coupon/index",{root:{cn:[]}},$||{}))},79181:function(e){e.exports=require("../../../../../../cwx/cpage/initNavigator")},91783:function(e){e.exports=require("../../../../../../cwx/cpage/ubt_wx")},56884:function(e){e.exports=require("../../../../../../cwx/cwx")},65238:function(e){e.exports=require("../../../../../../cwx/ext/global")},33675:function(e){e.exports=require("../../../../../../cwx/cwx")}},function(e){var t=function(t){return e(e.s=t)};e.O(0,[3177,2107,1216,8592],(function(){return t(98038)}));e.O()}]);
//# sourceMappingURL=index.js.map